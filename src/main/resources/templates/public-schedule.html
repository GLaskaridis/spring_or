<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Πρόγραμμα Μαθημάτων</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .header-title {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .btn-export {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            font-weight: 600;
        }
        .btn-export:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        .no-schedule {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        /* Tabs styling */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 24px;
        }
        .nav-tabs .nav-link:hover {
            border-bottom-color: #667eea;
            background: transparent;
        }
        .nav-tabs .nav-link.active {
            color: #764ba2;
            border-bottom-color: #764ba2;
            background: transparent;
        }
        
        /* Schedule table */
        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
            vertical-align: top;
        }
        .schedule-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        .schedule-table th.time-header {
            background: #495057;
            min-width: 120px;
        }
        .course-cell {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.85rem;
            text-align: left;
        }
        .course-cell.lab {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }
        .course-cell.tutorial {
            background: linear-gradient(135deg, #f1f8e9, #dcedc8);
        }
        .course-name {
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 4px;
        }
        .course-info {
            font-size: 0.8rem;
            color: #555;
            line-height: 1.4;
        }
        .semester-badge {
            background-color: #f093fb;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center header-title">
            <h1><i class="fas fa-calendar-alt"></i> Πρόγραμμα Μαθημάτων</h1>
            <p>Τελευταίο Εγκεκριμένο Πρόγραμμα</p>
        </div>

        <div class="card">
            <div class="card-header bg-white border-0 p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 id="scheduleName" class="mb-0">
                            <i class="fas fa-book-open text-primary"></i> 
                            <span id="scheduleTitle">Φόρτωση...</span>
                            <span id="semesterBadge" class="semester-badge" style="display:none;"></span>
                        </h3>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="exportBtn" class="btn btn-export" style="display:none;">
                            <i class="fas fa-file-excel"></i> Εξαγωγή σε Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div id="loadingDiv" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Φόρτωση...</span>
                    </div>
                    <p class="mt-3">Φόρτωση προγράμματος...</p>
                </div>
                
                <div id="noScheduleDiv" class="no-schedule" style="display:none;">
                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                    <h4>Δεν υπάρχει διαθέσιμο πρόγραμμα</h4>
                    <p>Δεν βρέθηκε εγκεκριμένο πρόγραμμα μαθημάτων.</p>
                </div>

                <div id="scheduleContent" style="display:none;">
                    <!-- Tabs για τα εξάμηνα -->
                    <ul class="nav nav-tabs mb-4" id="semesterTabs" role="tablist">
                        <!-- Θα συμπληρωθούν δυναμικά -->
                    </ul>
                    
                    <!-- Content για κάθε εξάμηνο -->
                    <div class="tab-content" id="semesterTabContent">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        //χρονικά διαστήματα
        const timeSlots = [
            {slot: 0, time: '08:00 - 10:00'},
            {slot: 1, time: '10:00 - 12:00'},
            {slot: 2, time: '12:00 - 14:00'},
            {slot: 3, time: '14:00 - 16:00'}
        ];

        const dayNames = {
            'MONDAY': 'Δευτέρα',
            'TUESDAY': 'Τρίτη',
            'WEDNESDAY': 'Τετάρτη',
            'THURSDAY': 'Πέμπτη',
            'FRIDAY': 'Παρασκευή'
        };

        const componentNames = {
            'THEORY': 'Θεωρία',
            'LAB': 'Εργαστήριο',
            'TUTORIAL': 'Φροντιστήριο'
        };

        let currentScheduleId = null;

        //φόρτωση προγράμματος
        async function loadSchedule() {
            try {
                const response = await fetch('/api/schedules/public/latest');
                
                if (!response.ok) {
                    throw new Error('δεν βρέθηκε πρόγραμμα');
                }

                const data = await response.json();
                currentScheduleId = data.scheduleId;
                
                //ενημέρωση τίτλου
                document.getElementById('scheduleTitle').textContent = data.scheduleName;
                
                //εμφάνιση εξαμήνου
                const semesterBadge = document.getElementById('semesterBadge');
                semesterBadge.textContent = data.semester;
                semesterBadge.style.display = 'inline-block';
                
                //εμφάνιση κουμπιού export
                document.getElementById('exportBtn').style.display = 'inline-block';
                
                //οργάνωση ανά εξάμηνο
                const resultsBySemester = organizeBySemester(data.results);
                
                //δημιουργία tabs και πινάκων
                createSemesterTabs(resultsBySemester);
                
                //εμφάνιση περιεχομένου
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('scheduleContent').style.display = 'block';
                
            } catch (error) {
                console.error('σφάλμα φόρτωσης:', error);
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('noScheduleDiv').style.display = 'block';
            }
        }

        //οργάνωση αποτελεσμάτων ανά εξάμηνο
        function organizeBySemester(results) {
            const bySemester = {};
            
            results.forEach(result => {
                const semester = result.semester || 1;
                if (!bySemester[semester]) {
                    bySemester[semester] = [];
                }
                bySemester[semester].push(result);
            });
            
            return bySemester;
        }

        //δημιουργία tabs και περιεχομένου για τα εξάμηνα
        function createSemesterTabs(resultsBySemester) {
            const tabsContainer = document.getElementById('semesterTabs');
            const contentContainer = document.getElementById('semesterTabContent');
            
            //ταξινόμηση εξαμήνων
            const semesters = Object.keys(resultsBySemester).map(Number).sort((a, b) => a - b);
            
            semesters.forEach((semester, index) => {
                const isActive = index === 0;
                
                //δημιουργία tab
                const tabLi = document.createElement('li');
                tabLi.className = 'nav-item';
                tabLi.innerHTML = `
                    <button class="nav-link ${isActive ? 'active' : ''}" 
                            id="semester${semester}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#semester${semester}" 
                            type="button" 
                            role="tab">
                        ${semester}ο Εξάμηνο
                    </button>
                `;
                tabsContainer.appendChild(tabLi);
                
                //δημιουργία περιεχομένου tab
                const tabContent = document.createElement('div');
                tabContent.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
                tabContent.id = `semester${semester}`;
                tabContent.setAttribute('role', 'tabpanel');
                
                //δημιουργία πίνακα για το εξάμηνο
                const tableHtml = createSemesterTable(resultsBySemester[semester]);
                tabContent.innerHTML = tableHtml;
                
                contentContainer.appendChild(tabContent);
            });
        }

        //δημιουργία πίνακα για ένα εξάμηνο
        function createSemesterTable(results) {
            //οργάνωση δεδομένων
            const schedule = {};
            results.forEach(result => {
                const key = `${result.day}_${result.timeSlot}`;
                if (!schedule[key]) {
                    schedule[key] = [];
                }
                schedule[key].push(result);
            });

            //δημιουργία HTML πίνακα
            let html = '<div class="table-responsive"><table class="schedule-table">';
            
            //header
            html += `
                <thead>
                    <tr>
                        <th class="time-header">Ώρα</th>
                        <th>Δευτέρα</th>
                        <th>Τρίτη</th>
                        <th>Τετάρτη</th>
                        <th>Πέμπτη</th>
                        <th>Παρασκευή</th>
                    </tr>
                </thead>
                <tbody>
            `;

            //γραμμές ανά χρονικό διάστημα
            timeSlots.forEach(({slot, time}) => {
                html += '<tr>';
                
                //στήλη ώρας
                html += `<td class="time-header"><strong>${time}</strong></td>`;

                //στήλες ημερών
                ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'].forEach(day => {
                    const key = `${day}_${slot}`;
                    const courses = schedule[key] || [];
                    
                    html += '<td>';
                    courses.forEach(course => {
                        const componentClass = course.courseComponent.toLowerCase();
                        html += `
                            <div class="course-cell ${componentClass}">
                                <div class="course-name">${course.courseName}</div>
                                <div class="course-info">
                                    ${course.courseCode} - ${componentNames[course.courseComponent] || course.courseComponent}<br>
                                    ${course.teacherName}<br>
                                    <i class="fas fa-door-open"></i> ${course.roomName}
                                </div>
                            </div>
                        `;
                    });
                    html += '</td>';
                });

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            
            return html;
        }

        //εξαγωγή σε excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (currentScheduleId) {
                window.open('/api/schedules/public/latest/export', '_blank');
            }
        });

        //φόρτωση κατά την εκκίνηση
        loadSchedule();
    </script>
</body>
</html>