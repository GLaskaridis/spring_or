<!DOCTYPE html>
<html lang="el" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Πρόγραμμα Μαθημάτων</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.85rem;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            min-width: 120px;
        }
        .schedule-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        .schedule-table th.time-header {
            background: #495057;
            min-width: 80px;
        }
        .course-cell {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 5px;
            padding: 5px;
            margin: 2px 0;
            font-size: 0.8rem;
        }
        .course-cell.LABORATORY {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }
        .course-name {
            font-weight: bold;
            color: #1565c0;
        }
        .course-room {
            font-size: 0.75rem;
            color: #666;
        }
        .semester-section {
            margin-bottom: 30px;
        }
        .semester-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        .empty-slot {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/users/user_dashboard">
                <i class="fas fa-graduation-cap me-2"></i>
                Σύστημα Χρονοπρογραμματισμού
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/users/user_dashboard">
                            <i class="fas fa-arrow-left me-1"></i>Επιστροφή
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/users/logout">
                            <i class="fas fa-sign-out-alt me-1"></i>Αποσύνδεση
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-calendar-check me-2"></i>Πρόγραμμα Μαθημάτων</h2>
<!--                        <p class="text-muted">
                            <strong>Χρονοπρογραμματισμός:</strong> <span id="schedule-name">Φόρτωση...</span>
                        </p>-->
                    </div>
                    <div>
                        <!-- selector -->
                        <select class="form-select" id="scheduleSelector" style="min-width: 250px;">
                            <option value="">Επιλέξτε Χρονοπρογραμματισμό</option>
                        </select>
                    </div>
                </div>

                <!-- alerts -->
                <div id="alert-container"></div>

                <!-- tabs για εξάμηνα -->
                <ul class="nav nav-tabs" id="semesterTabs" role="tablist">
                </ul>

                <!-- tab content -->
                <div class="tab-content border border-top-0 p-3" id="semesterTabContent">
                </div>

                <!-- empty state -->
                <div id="empty-state" class="text-center py-5" style="display: none;">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Δεν υπάρχουν διαθέσιμα δεδομένα</h5>
                    <p class="text-muted">Παρακαλώ επιλέξτε χρονοπρογραμματισμό</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scheduleDataBySemester = {};
        let userToken = localStorage.getItem('token');
        let username = localStorage.getItem('username');

        //μέρες εβδομάδας
        const daysOfWeek = [
            { id: 'MONDAY', label: 'Δευτέρα' },
            { id: 'TUESDAY', label: 'Τρίτη' },
            { id: 'WEDNESDAY', label: 'Τετάρτη' },
            { id: 'THURSDAY', label: 'Πέμπτη' },
            { id: 'FRIDAY', label: 'Παρασκευή' }
        ];

        //χρονικά slots (3ωρα όπως στο schedule-execution-result)
        const timeSlots = [
            { start: '09:00', end: '12:00', label: '09:00 - 12:00' },
            { start: '12:00', end: '15:00', label: '12:00 - 15:00' },
            { start: '15:00', end: '18:00', label: '15:00 - 18:00' },
            { start: '18:00', end: '21:00', label: '18:00 - 21:00' }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            if (!userToken || !username) {
                window.location.href = '/users/login';
                return;
            }

            loadSchedules();
            
            document.getElementById('scheduleSelector').addEventListener('change', loadScheduleData);
        });

        //φόρτωση όλων των χρονοπρογραμματισμών
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules', {
                    headers: {
                        'Authorization': 'Bearer ' + userToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const schedules = await response.json();
                    const selector = document.getElementById('scheduleSelector');
                    
                    schedules.forEach(schedule => {
                        const option = document.createElement('option');
                        option.value = schedule.id;
                        option.textContent = `${schedule.name} (${schedule.semester})`;
                        selector.appendChild(option);
                    });

                    //αυτόματη επιλογή του πρώτου αν υπάρχει
                    if (schedules.length > 0) {
                        selector.value = schedules[0].id;
                        loadScheduleData();
                    }
                } else {
                    showAlert('Σφάλμα φόρτωσης χρονοπρογραμματισμών', 'error');
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
                showAlert('Σφάλμα σύνδεσης', 'error');
            }
        }

        //φόρτωση δεδομένων επιλεγμένου χρονοπρογραμματισμού
        async function loadScheduleData() {
            const selectedScheduleId = document.getElementById('scheduleSelector').value;
            
            if (!selectedScheduleId) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('semesterTabs').innerHTML = '';
                document.getElementById('semesterTabContent').innerHTML = '';
                return;
            }

            try {
                //έλεγχος αν υπάρχουν αποτελέσματα
                const checkResponse = await fetch(`/api/schedules/${selectedScheduleId}/results/exists`, {
                    headers: {
                        'Authorization': 'Bearer ' + userToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    
                    if (checkData.hasResults) {
                        //φόρτωση πραγματικών αποτελεσμάτων
                        const resultsResponse = await fetch(`/api/schedules/${selectedScheduleId}/results`, {
                            headers: {
                                'Authorization': 'Bearer ' + userToken,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (resultsResponse.ok) {
                            const results = await resultsResponse.json();
                            console.log('Loaded results:', results);
                            
                            //ομαδοποίηση ανά εξάμηνο
                            scheduleDataBySemester = groupResultsBySemester(results);
                            
                            //εμφάνιση με tabs
                            renderScheduleWithTabs();
                            
                            showAlert('Τα δεδομένα φορτώθηκαν επιτυχώς', 'success');
                            
                        } else {
                            showAlert('Σφάλμα φόρτωσης αποτελεσμάτων', 'error');
                            document.getElementById('empty-state').style.display = 'block';
                        }
                    } else {
                        showAlert('Δεν υπάρχουν αποτελέσματα για αυτόν τον χρονοπρογραμματισμό', 'warning');
                        document.getElementById('empty-state').style.display = 'block';
                    }
                } else {
                    showAlert('Σφάλμα ελέγχου αποτελεσμάτων', 'error');
                }

            } catch (error) {
                console.error('Error loading schedule data:', error);
                showAlert('Σφάλμα κατά τη φόρτωση δεδομένων', 'error');
            }
        }

        //ομαδοποίηση αποτελεσμάτων ανά εξάμηνο
        function groupResultsBySemester(results) {
            const grouped = {};
            
            console.log('=== GROUPING RESULTS ===');
            console.log('Total results:', results.length);
            
            results.forEach((result, index) => {
                const semester = result.semester || 1;
                console.log(`Result ${index}: semester=${semester}, course=${result.courseName}`);
                
                if (!grouped[semester]) {
                    grouped[semester] = [];
                }
                grouped[semester].push(result);
            });
            
            console.log('=== GROUPED BY SEMESTER ===');
            Object.keys(grouped).forEach(sem => {
                console.log(`Semester ${sem}: ${grouped[sem].length} courses`);
            });
            
            return grouped;
        }

        //εμφάνιση προγράμματος με tabs
        function renderScheduleWithTabs() {
            const tabsContainer = document.getElementById('semesterTabs');
            const contentContainer = document.getElementById('semesterTabContent');
            
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            document.getElementById('empty-state').style.display = 'none';
            
            const semesters = Object.keys(scheduleDataBySemester).sort((a, b) => a - b);
            
            console.log('=== RENDERING TABS ===');
            console.log('Semesters found:', semesters);
            console.log('scheduleDataBySemester:', scheduleDataBySemester);
            
            if (semesters.length === 0) {
                console.log('No semesters found - showing empty state');
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            
            semesters.forEach((semester, index) => {
                console.log(`Creating tab for semester ${semester}, index ${index}`);
                
                //δημιουργία tab
                const tabLi = document.createElement('li');
                tabLi.className = 'nav-item';
                tabLi.innerHTML = `
                    <button class="nav-link ${index === 0 ? 'active' : ''}" 
                            id="semester-${semester}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#semester-${semester}" 
                            type="button">
                        ${semester}ο Εξάμηνο
                    </button>
                `;
                tabsContainer.appendChild(tabLi);
                
                //δημιουργία περιεχομένου tab
                const tabPane = document.createElement('div');
                tabPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
                tabPane.id = `semester-${semester}`;
                
                tabPane.innerHTML = renderSemesterTable(scheduleDataBySemester[semester]);
                contentContainer.appendChild(tabPane);
                
                console.log(`Created tab and pane for semester ${semester}`);
            });
            
            console.log('=== TABS RENDERING COMPLETE ===');
        }

        //δημιουργία πίνακα για συγκεκριμένο εξάμηνο
        function renderSemesterTable(semesterData) {
            //οργάνωση μαθημάτων σε πίνακα [ημέρα][slot]
            const schedule = {};
            const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
            
            //αρχικοποίηση κενού πίνακα
            days.forEach(day => {
                schedule[day] = {};
                timeSlots.forEach((slot, idx) => {
                    schedule[day][idx] = [];
                });
            });
            
            //τοποθέτηση μαθημάτων στον πίνακα
            semesterData.forEach(course => {
                const day = course.day;
                const startTime = course.startTime || '09:00';
                
                //εύρεση του σωστού slot με βάση την ώρα
                let slotIdx = 0;
                const hour = parseInt(startTime.split(':')[0]);
                
                if (hour >= 9 && hour < 12) slotIdx = 0;
                else if (hour >= 12 && hour < 15) slotIdx = 1;
                else if (hour >= 15 && hour < 18) slotIdx = 2;
                else if (hour >= 18) slotIdx = 3;
                
                if (schedule[day]) {
                    schedule[day][slotIdx].push(course);
                }
            });
            
            //δημιουργία html πίνακα
            let html = `
                <div class="table-responsive">
                    <table class="schedule-table table">
                        <thead>
                            <tr>
                                <th class="time-header">Ώρα</th>
                                ${daysOfWeek.map(day => `<th>${day.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            //για κάθε χρονικό slot
            timeSlots.forEach((slot, slotIdx) => {
                html += '<tr>';
                html += `<td class="time-header">${slot.label}</td>`;
                
                //για κάθε μέρα
                daysOfWeek.forEach(day => {
                    const courses = schedule[day.id][slotIdx] || [];
                    
                    html += '<td>';
                    
                    if (courses.length > 0) {
                        courses.forEach(course => {
                            const componentClass = course.courseComponent === 'LABORATORY' ? 'LABORATORY' : '';
                            html += `
                                <div class="course-cell ${componentClass}">
                                    <div class="course-name">${course.courseName}</div>
                                    <div class="course-code">${course.courseCode}</div>
                                    <div class="course-room"><i class="fas fa-door-open me-1"></i>${course.roomName}</div>
                                    <div class="course-teacher"><i class="fas fa-user me-1"></i>${course.teacherName}</div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<span class="empty-slot">-</span>';
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        //εμφάνιση alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning'
            }[type] || 'alert-info';

            const alertHTML = `
                <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            alertContainer.insertAdjacentHTML('beforeend', alertHTML);

            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    </script>
</body>
</html>