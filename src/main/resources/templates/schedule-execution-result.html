<!DOCTYPE html>
<html lang="el" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Αποτελέσματα Χρονοπρογραμματισμού</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .schedule-card { border-left: 4px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .time-slot { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border-radius: 5px; padding: 5px 10px; font-weight: bold; }
        .room-info { background-color: #f8f9fa; border-radius: 5px; padding: 5px; }
        .success-icon { color: #28a745; font-size: 1.2em; }
        .error-message { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .approved-badge { background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
        
        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.85rem;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            min-width: 120px;
        }
        .schedule-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        .schedule-table th.time-header {
            background: #495057;
            min-width: 80px;
        }
        .course-cell {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 5px;
            padding: 5px;
            margin: 2px 0;
            font-size: 0.8rem;
        }
        .course-cell.lab {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }
        .course-name {
            font-weight: bold;
            color: #1565c0;
        }
        .course-room {
            font-size: 0.75rem;
            color: #666;
        }
        .semester-section {
            margin-bottom: 30px;
        }
        .semester-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-calendar-check me-2 success-icon"></i>Αποτελέσματα Χρονοπρογραμματισμού</h2>
                        <p class="text-muted" th:if="${schedule}">
                            <strong>Χρονοπρογραμματισμός:</strong> <span th:text="${schedule.name}">N/A</span> |
                            <strong>ID:</strong> <span th:text="${schedule.id}">N/A</span> |
                            <strong>Κατάσταση:</strong> <span th:text="${schedule.status}">N/A</span>
                            <span th:if="${schedule.status.name() == 'SOLUTION_APPROVED'}" class="ms-2">
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Εγκεκριμένο
                                </span>
                            </span>
                        </p>
                    </div>
                    <div>
                        <a href="/admin/schedules" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i>Επιστροφή στα Προγράμματα
                        </a>
                        <a href="/users/admin_dashboard" class="btn btn-primary ms-2">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </div>
                </div>

                <div th:if="${schedule != null and schedule.status.name() == 'SOLUTION_APPROVED'}" class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>Πληροφορία:</strong> Αυτό το πρόγραμμα έχει ήδη εγκριθεί. Δεν μπορείτε να το τροποποιήσετε.
                    </div>
                </div>

                <div th:if="${success}" class="alert alert-success d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <div>
                        <strong>Επιτυχία!</strong> Ο χρονοπρογραμματισμός ολοκληρώθηκε επιτυχώς.
                        <span th:if="${assignments}">
                            Βρέθηκαν <strong th:text="${#lists.size(assignments)}">0</strong> αποτελέσματα.
                        </span>
                    </div>
                </div>

                <div th:if="${error}" class="error-message">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>Σφάλμα</h4>
                    <p th:text="${error}">Μήνυμα σφάλματος</p>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="location.href='/admin/schedules'">
                            <i class="fas fa-arrow-left me-1"></i>Επιστροφή στα Προγράμματα
                        </button>
                        <button type="button" class="btn btn-warning ms-2" th:if="${schedule}" th:onclick="'regenerateSchedule(' + ${schedule.id} + ')'"
                                th:disabled="${schedule.status.name() == 'SOLUTION_APPROVED'}">
                            <i class="fas fa-redo me-1"></i>Προσπάθεια Ξανά
                        </button>
                    </div>
                </div>

                <div th:if="${assignments != null and !#lists.isEmpty(assignments)}">
                    
                    <div id="semesterSchedules">
                        </div>
                    
                    <div class="card mt-4">
                        <div class="card-footer bg-white">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-success btn-lg" 
                                                th:onclick="'approveSchedule(' + ${schedule.id} + ')'"
                                                th:disabled="${schedule.status.name() == 'SOLUTION_APPROVED'}">
                                            <i class="fas fa-check me-2"></i>Έγκριση Προγράμματος
                                        </button>
                                    </div>
                                    <small class="text-muted mt-2 d-block" th:if="${schedule.status.name() != 'SOLUTION_APPROVED'}">
                                        Επικύρωση και αποθήκευση του προγράμματος
                                    </small>
                                    <small class="text-success mt-2 d-block" th:if="${schedule.status.name() == 'SOLUTION_APPROVED'}">
                                        <i class="fas fa-check-circle me-1"></i>Το πρόγραμμα έχει εγκριθεί
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-warning btn-lg" 
                                                th:onclick="'regenerateSchedule(' + ${schedule.id} + ')'"
                                                th:disabled="${schedule.status.name() == 'SOLUTION_APPROVED'}">
                                            <i class="fas fa-redo me-2"></i>Επανεκτέλεση
                                        </button>
                                    </div>
                                    <small class="text-muted mt-2 d-block" th:if="${schedule.status.name() != 'SOLUTION_APPROVED'}">
                                        Δημιουργία νέου προγράμματος
                                    </small>
                                    <small class="text-muted mt-2 d-block" th:if="${schedule.status.name() == 'SOLUTION_APPROVED'}">
                                        <i class="fas fa-lock me-1"></i>Μη διαθέσιμο για εγκεκριμένα προγράμματα
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid">
                                        <a href="/admin/schedules" class="btn btn-outline-secondary btn-lg">
                                            <i class="fas fa-list me-2"></i>Προβολή Όλων
                                        </a>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Επιστροφή στη λίστα προγραμμάτων</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:unless="${assignments}" class="error-message">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>Δεν Βρέθηκαν Αποτελέσματα</h4>
                    <p>Δεν υπάρχουν δεδομένα assignments στο model.</p>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="location.href='/admin/schedules'">
                            <i class="fas fa-arrow-left me-1"></i>Επιστροφή στα Προγράμματα
                        </button>
                        <button type="button" class="btn btn-warning ms-2" th:if="${schedule}" 
                                th:onclick="'regenerateSchedule(' + ${schedule.id} + ')'"
                                th:disabled="${schedule?.status?.name() == 'SOLUTION_APPROVED'}">
                            <i class="fas fa-redo me-1"></i>Προσπάθεια Ξανά
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        //δημιουργία array με τα assignments
        var assignmentsData = [];
        
        /*[# th:each="assignment : ${assignments}"]*/
        assignmentsData.push({
            courseName: /*[[${assignment.course?.name}]]*/ 'Unknown',
            courseCode: /*[[${assignment.course?.code}]]*/ 'N/A',
            courseSemester: /*[[${assignment.course?.semester}]]*/ 1,
            courseYear: /*[[${assignment.course?.year}]]*/ 1,
            courseComponent: /*[[${assignment.course?.activeComponent?.name()}]]*/ 'THEORY',
            roomName: /*[[${assignment.room?.name}]]*/ 'N/A',
            day: /*[[${assignment.day?.name()}]]*/ 'MONDAY',
            startTime: /*[[${assignment.startTime?.toString()}]]*/ '09:00',
            endTime: /*[[${assignment.endTime?.toString()}]]*/ '12:00'
        });
        /*[/]*/
        
        var isApproved = /*[[${schedule?.status?.name() == 'SOLUTION_APPROVED'}]]*/ false;
        var scheduleId = /*[[${schedule?.id}]]*/ null;
        
        console.log('Loaded assignments:', assignmentsData);
    </script>
    
    <script>
        //ημέρες της εβδομάδας με ελληνικά ονόματα
        const dayNames = {
            'MONDAY': 'Δευτέρα',
            'TUESDAY': 'Τρίτη',
            'WEDNESDAY': 'Τετάρτη',
            'THURSDAY': 'Πέμπτη',
            'FRIDAY': 'Παρασκευή'
        };
        
        //χρονικά διαστήματα
        const timeSlots = [
            { start: '09:00', end: '12:00', label: '09:00 - 12:00' },
            { start: '12:00', end: '15:00', label: '12:00 - 15:00' },
            { start: '15:00', end: '18:00', label: '15:00 - 18:00' },
            { start: '18:00', end: '21:00', label: '18:00 - 21:00' }
        ];
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - assignmentsData:', assignmentsData);
            
            if (assignmentsData && assignmentsData.length > 0) {
                renderSchedulesBySemester(assignmentsData);
            } else {
                console.log('No assignments data found');
            }
        });
        
        function renderSchedulesBySemester(data) {
            //ομαδοποίηση μαθημάτων ανά εξάμηνο
            const bySemester = {};
            
            data.forEach(assignment => {
                //χρήση courseSemester, με fallback στο 1 αν είναι null/undefined/0
                let semester = assignment.courseSemester;
                if (!semester || semester === 0 || semester === null) {
                    semester = 1;
                }
                
                if (!bySemester[semester]) {
                    bySemester[semester] = [];
                }
                bySemester[semester].push(assignment);
            });
            
            console.log('Grouped by semester:', bySemester);
            
            //ταξινόμηση εξαμήνων
            const sortedSemesters = Object.keys(bySemester).sort((a, b) => parseInt(a) - parseInt(b));
            
            const container = document.getElementById('semesterSchedules');
            container.innerHTML = '';
            
            sortedSemesters.forEach(semester => {
                const semesterHtml = createSemesterTable(semester, bySemester[semester]);
                container.innerHTML += semesterHtml;
            });
        }
        
        function createSemesterTable(semester, assignments) {
            //οργάνωση μαθημάτων σε πίνακα [ημέρα][slot]
            const schedule = {};
            const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
            
            //αρχικοποίηση κενού πίνακα
            days.forEach(day => {
                schedule[day] = {};
                timeSlots.forEach((slot, idx) => {
                    schedule[day][idx] = [];
                });
            });
            
            //τοποθέτηση μαθημάτων στον πίνακα
            assignments.forEach(assignment => {
                const day = assignment.day;
                const startTime = assignment.startTime || '09:00';
                
                //εύρεση του σωστού slot με βάση την ώρα
                let slotIdx = 0;
                const hour = parseInt(startTime.split(':')[0]);
                
                if (hour >= 9 && hour < 12) slotIdx = 0;
                else if (hour >= 12 && hour < 15) slotIdx = 1;
                else if (hour >= 15 && hour < 18) slotIdx = 2;
                else if (hour >= 18) slotIdx = 3;
                
                if (schedule[day]) {
                    schedule[day][slotIdx].push(assignment);
                }
            });
            
            //δημιουργία HTML πίνακα
            let html = `
                <div class="semester-section">
                    <div class="semester-header">
                        <i class="fas fa-graduation-cap me-2"></i>
                        ${semester}ο Εξάμηνο
                        <span class="badge bg-light text-dark ms-2">${assignments.length} μαθήματα</span>
                    </div>
                    <div class="card" style="border-radius: 0 0 10px 10px;">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="schedule-table">
                                    <thead>
                                        <tr>
                                            <th class="time-header">Ώρα</th>
            `;
            
            //κεφαλίδες ημερών
            days.forEach(day => {
                html += `<th>${dayNames[day]}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            //γραμμές για κάθε slot
            timeSlots.forEach((slot, slotIdx) => {
                html += `<tr><td class="time-header"><strong>${slot.label}</strong></td>`;
                
                days.forEach(day => {
                    const courses = schedule[day][slotIdx];
                    html += '<td>';
                    
                    if (courses && courses.length > 0) {
                        courses.forEach(course => {
                            const isLab = course.courseComponent === 'LABORATORY';
                            const componentType = isLab ? '(Εργ.)' : '(Θ.)';
                            
                            html += `
                                <div class="course-cell ${isLab ? 'lab' : ''}">
                                    <div class="course-name">${course.courseName || 'Άγνωστο'}</div>
                                    <div class="course-room">
                                        <i class="fas fa-door-open me-1"></i>${course.roomName || 'N/A'}
                                    </div>
                                    <small class="text-muted">${componentType}</small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<span class="text-muted">-</span>';
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += `</tbody></table></div></div></div></div>`;
            
            return html;
        }
        
        function approveSchedule(id) {
            if (isApproved) {
                alert('Το πρόγραμμα έχει ήδη εγκριθεί και δεν μπορεί να τροποποιηθεί.');
                return;
            }
            
            if (confirm('Είστε σίγουροι ότι θέλετε να εγκρίνετε αυτό το πρόγραμμα;')) {
                if (!id) {
                    alert('Σφάλμα: Δεν βρέθηκε ID προγράμματος');
                    return;
                }
                
                //σωστό endpoint: /schedule-execution/api/approve/
                fetch('/schedule-execution/api/approve/' + id, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('userToken') || '')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Το πρόγραμμα εγκρίθηκε επιτυχώς!');
                        location.reload();
                    } else {
                        alert('Σφάλμα κατά την έγκριση: ' + (data.message || 'Άγνωστο σφάλμα'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Σφάλμα δικτύου κατά την έγκριση');
                });
            }
        }

        function regenerateSchedule(id) {
            if (isApproved) {
                alert('Το πρόγραμμα έχει ήδη εγκριθεί και δεν μπορεί να επανεκτελεστεί.');
                return;
            }
            
            if (confirm('Θέλετε να δημιουργήσετε νέο πρόγραμμα; Το τρέχον θα χαθεί.')) {
                if (!id) {
                    alert('Σφάλμα: Δεν βρέθηκε ID προγράμματος');
                    return;
                }
                
                location.href = '/schedule-execution/execute/' + id;
            }
        }
    </script>
</body>
</html>